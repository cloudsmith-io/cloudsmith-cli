set -e

# --- Keep a venv at .venv
export VIRTUAL_ENV=.venv

# --- Choose a Python interpreter (system-friendly)
PYTHON_BIN="$(command -v python3 || command -v python || true)"
if [ -z "$PYTHON_BIN" ]; then
  echo "Error: No python3/python found on PATH." >&2
  exit 1
fi

# Honour an explicit PYTHON_VERSION if the env provides it; otherwise use the interpreter's version
if [ -z "${PYTHON_VERSION:-}" ]; then
  PYTHON_VERSION="$("$PYTHON_BIN" -c 'import sys; print(".".join(map(str, sys.version_info[:3])))')"
fi
echo "Using $PYTHON_BIN (Python $PYTHON_VERSION)"

# --- Recreate venv if version inside .venv doesn't match desired
if [ -d ".venv" ]; then
  CURRENT_VERSION="$(. .venv/bin/activate >/dev/null 2>&1 && python --version 2>&1 | cut -d' ' -f2 || true)"
  if [ "$CURRENT_VERSION" != "$PYTHON_VERSION" ]; then
    echo "Current Python version ($CURRENT_VERSION) != desired ($PYTHON_VERSION). Recreating .venv ..."
    rm -rf .venv
  fi
fi

# --- Ensure 'uv' is available to bootstrap (PEP 668 safe: use --user if needed)
if ! "$PYTHON_BIN" -c 'import uv' >/dev/null 2>&1; then
  # Try installing uv for the base interpreter with --user to avoid system conflicts
  "$PYTHON_BIN" -m pip install --user -U uv >/dev/null 2>&1 || true
fi

# --- Create the venv (prefer uv; fall back to stdlib venv)
if [ ! -d ".venv" ]; then
  if "$PYTHON_BIN" -c 'import uv' >/dev/null 2>&1; then
    # uv accepts a path for --python; avoids version mismatch
    "$PYTHON_BIN" -m uv venv .venv --python "$PYTHON_BIN"
  else
    "$PYTHON_BIN" -m venv .venv
  fi
fi

# --- Activate venv
source ./.venv/bin/activate

# --- Ensure tooling inside venv
python -m pip install -U pip
python -m pip install -U uv

# --- Install the project in editable mode (prefer uv pip; fallback to pip)
if python -m uv --help >/dev/null 2>&1; then
  python -m uv pip install -e .
else
  pip install -e .
fi

# --- Load environment variables from .env (create from example if missing)
if [ ! -f .env ]; then
  cp .env.example .env
fi
dotenv

# --- Install pre-commit hooks
pre-commit install

# --- Python / Locale
export PYTHONDONTWRITEBYTECODE=1
export LC_ALL='en_US.UTF-8'
export LANG='en_US.UTF-8'
export LANGUAGE='en_US.UTF-8'

# --- PATH
path_add PATH "$(expand_path bin)"
