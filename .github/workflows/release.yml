name: Create Zipapp and Release

on:
    push:
        tags:
            - "v*"

permissions:
  id-token: write
  contents: write

jobs:
    # Build and publish to GitHub, Cloudsmith (zipapp + Docker)
    build:
        name: Build and publish artifacts
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.10
              uses: actions/setup-python@v5
              with:
                  python-version: '3.10'
                  cache: 'pip'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pex

            - name: Get version
              id: get_version
              run: echo "VERSION=$(cat cloudsmith_cli/data/VERSION)" >> $GITHUB_ENV

            - name: Create Zipapp with pex (cross-platform)
              run: |
                  pex . \
                    --output-file cloudsmith-${{ env.VERSION }}.pyz \
                    --console-script cloudsmith \
                    --python-shebang "/usr/bin/env python3" \
                    --venv \
                    --complete-platform .github/.platforms/linux-x86_64-py310.json \
                    --complete-platform .github/.platforms/linux-aarch64-py310.json \
                    --complete-platform .github/.platforms/linux-x86_64-musl-py310.json \
                    --complete-platform .github/.platforms/linux-aarch64-musl-py310.json \
                    --complete-platform .github/.platforms/macos-arm64-py310.json \
                    --complete-platform .github/.platforms/windows-x86_64-py310.json

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: v${{ env.VERSION }}
                  release_name: Release v${{ env.VERSION }}
                  draft: false
                  prerelease: false

            - name: Upload Release Asset
              id: upload-release-asset
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./cloudsmith-${{ env.VERSION }}.pyz
                  asset_name: cloudsmith-${{ env.VERSION }}.pyz
                  asset_content_type: application/zip

            - name: Install and authenticate Cloudsmith CLI
              uses: cloudsmith-io/cloudsmith-cli-action@v1
              with:
                  oidc-namespace: ${{ vars.CLOUDSMITH_NAMESPACE }}
                  oidc-service-slug: ${{ vars.CLOUDSMITH_SVC_SLUG }}

            - name: Push Zipapp to Cloudsmith
              id: push_zipapp
              run: cloudsmith push raw ${{ vars.CLOUDSMITH_NAMESPACE }}/cli-zipapp ./cloudsmith-${{ env.VERSION }}.pyz --name cloudsmith-cli --version ${{ env.VERSION }}

            - name: Install build dependencies for Python packages
              run: pip install setuptools wheel

            - name: Build Python packages
              run: python setup.py sdist bdist_wheel

            - name: Push source distribution to Cloudsmith
              run: cloudsmith push python ${{ vars.CLOUDSMITH_NAMESPACE }}/cli dist/cloudsmith-cli-${{ env.VERSION }}.tar.gz

            - name: Push wheel to Cloudsmith
              run: cloudsmith push python ${{ vars.CLOUDSMITH_NAMESPACE }}/cli dist/cloudsmith_cli-${{ env.VERSION }}-py3-none-any.whl

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Cloudsmith Docker Registry
              uses: docker/login-action@v3
              with:
                  registry: docker.cloudsmith.io
                  username: ${{ vars.CLOUDSMITH_SVC_SLUG }}
                  password: ${{ env.CLOUDSMITH_API_KEY }}

            - name: Login to DockerHub
              uses: docker/login-action@v3
              with:
                  username: ${{ vars.DOCKERHUB_USER }}
                  password: ${{ secrets.DOCKERHUB_PAT }}

            - name: Build and push multi-arch Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  platforms: linux/amd64,linux/arm64
                  push: true
                  build-args: |
                      CLOUDSMITH_CLI_VERSION=${{ env.VERSION }}
                  tags: |
                      docker.cloudsmith.io/${{ vars.CLOUDSMITH_NAMESPACE }}/cli-zipapp/cloudsmith-cli:${{ env.VERSION }}
                      docker.cloudsmith.io/${{ vars.CLOUDSMITH_NAMESPACE }}/cli-zipapp/cloudsmith-cli:latest
                      cloudsmith/cloudsmith-cli:${{ env.VERSION }}
                      cloudsmith/cloudsmith-cli:latest

    # Publish Python packages to PyPI
    publish-pypi:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.10
              uses: actions/setup-python@v5
              with:
                  python-version: '3.10'

            - name: Install build dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install setuptools wheel

            - name: Build packages
              run: python setup.py sdist bdist_wheel

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/
